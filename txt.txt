let video, poseNet, poses = [], currentUser = null, db;
let appState = "goal_selection";
let sessionStartTime, isReady = false;
// 'currentTracker' is defined by the exercise-specific file.

// p5.js setup function
function setup() {
  console.log("1. p5.js setup() started.");
  createCanvas(640, 480);
  background(0);
  fill(255);
  textAlign(CENTER, CENTER);
  text("Initializing...", width / 2, height / 2);
  noLoop(); // IMPORTANT: Stop the draw loop until we are ready.

  video = createCapture(VIDEO, function(stream) {
    console.log("2. Camera stream is ready.");
    video.size(width, height);
    video.hide();
    
    firebase.auth().onAuthStateChanged((user) => {
      console.log("3. Firebase auth state changed.");
      if (user) {
        currentUser = user;
        db = firebase.firestore();
        initializeSketch();
      } else {
        console.log("User not logged in. Redirecting...");
        window.location.href = "login.html";
      }
    });
  });

  // Handle potential camera errors
  video.elt.addEventListener('error', (e) => {
    console.error("Camera Error:", e);
    alert("Could not access the camera. Please check browser permissions and ensure no other application is using it.");
  });
}

function initializeSketch() {
  console.log("4. Initializing Sketch (loading PoseNet)...");
  poseNet = ml5.poseNet(video, () => {
    console.log(`5. PoseNet Model Loaded for ${currentTracker.name}!`);
    
    // Setup UI based on exercise type
    if (currentTracker.name === "Gait Analysis") {
      appState = "exercise";
      const startStopButton = createButton('Start Test');
      startStopButton.position(width / 2 - 50, height - 40);
      startStopButton.mousePressed(() => {
          currentTracker.toggleTest();
          startStopButton.html(currentTracker.state === 'walking' ? 'Stop Test & Analyze' : 'Start Test');
      });
    } else {
      appState = "goal_selection";
      const goalButtons = selectAll(".goalButton");
      goalButtons.forEach((button) => {
        button.mousePressed(() => setGoal(button.attribute("data-goal")));
      });
      const endButton = select("#endButton");
      endButton.mousePressed(handleEndRestart);
    }

    updateButtonVisibility();
    isReady = true;
    console.log("6. Initialization complete. Starting draw loop.");
    loop(); // IMPORTANT: Start the draw loop now.
  });
}

// p5.js draw function
function draw() {
  if (!isReady) return;

  if (appState === "goal_selection") {
    drawGoalScreen();
  } else if (appState === "exercise") {
    drawExerciseScreen();
  } else if (appState === "loading") {
    drawLoadingScreen();
  }
}

function drawGoalScreen() {
  background(0);
  fill(255);
  textAlign(CENTER, CENTER);
  textSize(32);
  text(`Select a Goal for ${currentTracker.name}`, width / 2, height / 2 - 50);
}

// --- All other functions (setGoal, handleEndRestart, etc.) remain the same ---

function setGoal(goal) {
  currentTracker.setGoal(goal);
  appState = "exercise";
  sessionStartTime = new Date();
  updateButtonVisibility();
}

window.handleEndRestart = function() {
    if (appState === "loading") return;
    appState = "loading";
    
    const analysisData = (currentTracker.name === "Gait Analysis") 
        ? currentTracker.repsData[0] || { summary: "Analysis failed.", recommendation: "Please try the test again." }
        : currentTracker.generateAnalysis();

    const analysisReport = `${analysisData.summary}\n\n${analysisData.recommendation}`;
    
    saveForResultsPage(analysisReport);
    saveSessionToFirebase();
    window.location.href = "results.html";
}

function saveForResultsPage(analysisReport) {
    sessionStorage.setItem("analysisReport", analysisReport);
    sessionStorage.setItem("exerciseName", currentTracker.name);
    sessionStorage.setItem("exerciseGoal", currentTracker.goal || 'N/A');
    sessionStorage.setItem("completedReps", currentTracker.count || currentTracker.steps || 0);
}

function saveSessionToFirebase() {
  if (!currentUser) return;
  const sessionData = {
    exercise: currentTracker.name,
    goal: currentTracker.goal || 'N/A',
    completed_reps: currentTracker.count || 0,
    steps: currentTracker.steps || 0,
    startTime: sessionStartTime || new Date(),
    endTime: new Date(),
    duration_seconds: sessionStartTime ? parseFloat(((new Date().getTime() - sessionStartTime.getTime()) / 1000).toFixed(2)) : parseFloat(((currentTracker.endTime - currentTracker.startTime)/1000).toFixed(2)) || 0,
    reps_data: currentTracker.repsData || [],
  };
  db.collection("users").doc(currentUser.uid).collection("workouts").add(sessionData)
    .then((docRef) => console.log("SUCCESS: Session saved"))
    .catch((error) => console.error("FIREBASE ERROR: ", error));
}

function updateButtonVisibility() {
    const goalSel = select("#goalSelection");
    const endBtn = select("#endButton");
    if (!goalSel && !endBtn && currentTracker.name !== "Gait Analysis") return;
    if (currentTracker.name === "Gait Analysis") {
        if (goalSel) goalSel.hide();
        if (endBtn) endBtn.hide();
        return;
    }
    if (appState === "goal_selection") {
        goalSel.style("display", "block");
        endBtn.hide();
    } else {
        goalSel.style("display", "none");
        endBtn.html(appState === "exercise" ? "End Early & Save" : "Restart");
        endBtn.show();
    }
}

function drawKeypoints(detection) {
  for (let keypoint of detection.pose.keypoints) {
    if (keypoint.score > 0.2) {
      fill(0, 255, 0);
      noStroke();
      ellipse(keypoint.position.x, keypoint.position.y, 10, 10);
    }
  }
}

function drawSkeleton(detection) {
  for (let skeleton of detection.skeleton) {
    let partA = skeleton[0];
    let partB = skeleton[1];
    stroke(0, 255, 255);
    line(partA.position.x, partA.position.y, partB.position.x, partB.position.y);
  }
}

function drawExerciseScreen() {
  push();
  translate(width, 0);
  scale(-1, 1);
  image(video, 0, 0, width, height);
  if (poses.length > 0) {
    const detection = poses[0]; 
    drawKeypoints(detection);
    drawSkeleton(detection);
    currentTracker.detect(detection.pose);
    currentTracker.checkForm(detection.pose);
  }
  pop(); 
  currentTracker.drawUI();
  if (currentTracker.goal > 0 && currentTracker.count >= currentTracker.goal && appState === "exercise") {
    handleEndRestart();
  }
}

function drawLoadingScreen() {
    push();
    translate(width, 0); scale(-1, 1);
    image(video, 0, 0, width, height);
    pop();
    fill(0, 0, 0, 180);
    rect(0, 0, width, height);
    fill(255);
    textAlign(CENTER, CENTER);
    textSize(24);
    text("Saving and Generating Analysis...", width / 2, height / 2);
}